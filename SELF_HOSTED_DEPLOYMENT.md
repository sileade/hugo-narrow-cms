# ðŸš€ Self-Hosted Deployment Guide

Complete guide for deploying Hugo Narrow CMS on your own server with Docker Compose.

## ðŸ“‹ Table of Contents

- [Quick Start](#quick-start)
- [Prerequisites](#prerequisites)
- [Installation](#installation)
- [Configuration](#configuration)
- [Deployment](#deployment)
- [Management](#management)
- [Troubleshooting](#troubleshooting)

---

## âš¡ Quick Start

**Deploy in 3 commands:**

```bash
git clone https://github.com/sileade/hugo-narrow-cms.git
cd hugo-narrow-cms
./quick-start.sh
```

Choose option 2 for production deployment.

---

## ðŸ“¦ Prerequisites

### Server Requirements

| Component | Minimum | Recommended |
|-----------|---------|-------------|
| CPU | 1 core | 2+ cores |
| RAM | 1 GB | 2+ GB |
| Storage | 10 GB | 20+ GB |
| OS | Ubuntu 20.04+ | Ubuntu 22.04+ |

### Software Requirements

- **Docker** 20.10+
- **Docker Compose** 2.0+
- **Git**
- **Domain name** (for SSL)

### Install Docker

```bash
# Install Docker
curl -fsSL https://get.docker.com | sh

# Add user to docker group
sudo usermod -aG docker $USER

# Start Docker
sudo systemctl enable docker
sudo systemctl start docker

# Verify
docker --version
docker-compose --version
```

---

## ðŸ”§ Installation

### 1. Clone Repository

```bash
cd /opt
git clone https://github.com/sileade/hugo-narrow-cms.git
cd hugo-narrow-cms
```

### 2. Configure Environment

```bash
# Copy example environment file
cp .env.example .env

# Edit configuration
nano .env
```

**Required variables:**

```bash
# Domain Configuration
DOMAIN=yourdomain.com
ACME_EMAIL=your-email@example.com

# Admin Panel Credentials
ADMIN_USERNAME=admin
ADMIN_PASSWORD=your-strong-password-here

# Database
POSTGRES_PASSWORD=your-db-password-here

# Secrets (generate with: openssl rand -hex 32)
ADMIN_SECRET_KEY=your-secret-key-here
UMAMI_SECRET=your-umami-secret-here
WEBHOOK_SECRET=your-webhook-secret-here

# Traefik Dashboard Auth (generate with: htpasswd -nb admin password)
TRAEFIK_AUTH=admin:$apr1$xyz...

# Git Configuration
GIT_USER_NAME=Your Name
GIT_USER_EMAIL=your-email@example.com
```

### 3. Generate Secrets

```bash
# Generate random secrets
echo "ADMIN_SECRET_KEY=$(openssl rand -hex 32)" >> .env
echo "UMAMI_SECRET=$(openssl rand -hex 32)" >> .env
echo "WEBHOOK_SECRET=$(openssl rand -hex 32)" >> .env

# Generate Traefik auth (requires apache2-utils)
sudo apt-get install apache2-utils
htpasswd -nb admin yourpassword
# Copy output to TRAEFIK_AUTH in .env
```

---

## ðŸš€ Deployment

### Option 1: Quick Start Script (Recommended)

```bash
./quick-start.sh
```

Select **option 2** for production deployment.

### Option 2: Full Production Script

```bash
./deploy-prod.sh
```

This script will:
1. âœ… Validate environment variables
2. âœ… Create necessary directories
3. âœ… Build Hugo site
4. âœ… Pull Docker images
5. âœ… Build custom images
6. âœ… Start all services
7. âœ… Display access URLs

### Option 3: Manual Deployment

```bash
# Build Hugo site
hugo --minify

# Start services
docker-compose -f docker-compose.prod.yml up -d

# View logs
docker-compose -f docker-compose.prod.yml logs -f
```

---

## ðŸŒ DNS Configuration

Point your domain to your server:

```
Type: A
Name: @
Value: YOUR_SERVER_IP

Type: A
Name: monitor
Value: YOUR_SERVER_IP

Type: A
Name: analytics
Value: YOUR_SERVER_IP

Type: A
Name: traefik
Value: YOUR_SERVER_IP
```

**Wait 5-10 minutes for DNS propagation.**

---

## ðŸ”’ SSL Certificates

SSL certificates are automatically generated by Let's Encrypt via Traefik.

**Process:**
1. Traefik detects HTTP requests
2. Requests SSL certificate from Let's Encrypt
3. Validates domain ownership
4. Issues certificate
5. Auto-renews before expiration

**Check certificate status:**

```bash
docker-compose -f docker-compose.prod.yml logs traefik | grep acme
```

---

## ðŸ“Š Services

Your deployment includes these services:

| Service | URL | Description |
|---------|-----|-------------|
| **Website** | `https://yourdomain.com` | Main Hugo site |
| **Admin Panel** | `https://yourdomain.com/admin` | Flask admin interface |
| **Monitoring** | `https://monitor.yourdomain.com` | Uptime Kuma |
| **Analytics** | `https://analytics.yourdomain.com` | Umami analytics |
| **Traefik Dashboard** | `https://traefik.yourdomain.com` | Reverse proxy dashboard |
| **Webhook** | `https://yourdomain.com/hooks` | Auto-deploy webhook |

---

## ðŸŽ›ï¸ Management

### View Logs

```bash
# All services
docker-compose -f docker-compose.prod.yml logs -f

# Specific service
docker-compose -f docker-compose.prod.yml logs -f hugo
docker-compose -f docker-compose.prod.yml logs -f admin
docker-compose -f docker-compose.prod.yml logs -f traefik
```

### Restart Services

```bash
# All services
docker-compose -f docker-compose.prod.yml restart

# Specific service
docker-compose -f docker-compose.prod.yml restart hugo
```

### Stop Services

```bash
docker-compose -f docker-compose.prod.yml down
```

### Update Site

```bash
# Pull latest changes
git pull

# Rebuild and restart
./deploy-prod.sh
```

### Backup

```bash
# Manual backup
tar -czf backup-$(date +%Y%m%d).tar.gz content/ static/ postgres/

# Automatic backups run daily
# Check backups directory
ls -lh backups/
```

### Restore Backup

```bash
# Stop services
docker-compose -f docker-compose.prod.yml down

# Extract backup
tar -xzf backup-YYYYMMDD.tar.gz

# Start services
docker-compose -f docker-compose.prod.yml up -d
```

---

## ðŸ” Security

### Firewall Configuration

```bash
# Install UFW
sudo apt-get install ufw

# Allow SSH
sudo ufw allow 22/tcp

# Allow HTTP/HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# Enable firewall
sudo ufw enable

# Check status
sudo ufw status
```

### Update System

```bash
# Update packages
sudo apt-get update && sudo apt-get upgrade -y

# Update Docker images
docker-compose -f docker-compose.prod.yml pull
docker-compose -f docker-compose.prod.yml up -d
```

### Change Admin Password

```bash
# Edit .env file
nano .env

# Update ADMIN_PASSWORD

# Restart admin service
docker-compose -f docker-compose.prod.yml restart admin
```

---

## ðŸ“ˆ Monitoring

### Uptime Kuma Setup

1. Open `https://monitor.yourdomain.com`
2. Create admin account
3. Add monitors:
   - Website: `https://yourdomain.com`
   - Admin: `https://yourdomain.com/admin`
   - Analytics: `https://analytics.yourdomain.com`

### Umami Analytics Setup

1. Open `https://analytics.yourdomain.com`
2. Default login: `admin` / `umami`
3. Change password immediately
4. Add website
5. Get tracking code
6. Add to Hugo templates

---

## ðŸ”„ Auto-Deploy with Webhook

### Setup GitHub Webhook

1. Go to GitHub repository settings
2. Navigate to **Webhooks** â†’ **Add webhook**
3. Set Payload URL: `https://yourdomain.com/hooks/hugo-deploy`
4. Content type: `application/json`
5. Secret: (from .env WEBHOOK_SECRET)
6. Events: **Just the push event**
7. Save webhook

### Test Webhook

```bash
# Make a change and push
git commit -am "test webhook"
git push

# Check logs
docker-compose -f docker-compose.prod.yml logs -f webhook
```

---

## ðŸ› Troubleshooting

### Services Not Starting

```bash
# Check service status
docker-compose -f docker-compose.prod.yml ps

# View error logs
docker-compose -f docker-compose.prod.yml logs

# Restart services
docker-compose -f docker-compose.prod.yml restart
```

### SSL Certificate Issues

```bash
# Check Traefik logs
docker-compose -f docker-compose.prod.yml logs traefik

# Verify DNS
nslookup yourdomain.com

# Check Let's Encrypt rate limits
# https://letsencrypt.org/docs/rate-limits/

# Force certificate renewal
docker-compose -f docker-compose.prod.yml restart traefik
```

### Website Not Accessible

```bash
# Check if services are running
docker-compose -f docker-compose.prod.yml ps

# Check Traefik routing
docker-compose -f docker-compose.prod.yml logs traefik | grep yourdomain.com

# Verify DNS
ping yourdomain.com

# Check firewall
sudo ufw status
```

### Admin Panel Not Working

```bash
# Check admin service logs
docker-compose -f docker-compose.prod.yml logs admin

# Restart admin service
docker-compose -f docker-compose.prod.yml restart admin

# Verify credentials in .env
cat .env | grep ADMIN
```

### Database Issues

```bash
# Check database logs
docker-compose -f docker-compose.prod.yml logs db

# Restart database
docker-compose -f docker-compose.prod.yml restart db

# Backup database
docker exec hugo-postgres pg_dump -U umami umami > backup.sql

# Restore database
docker exec -i hugo-postgres psql -U umami umami < backup.sql
```

---

## ðŸ“Š Performance Optimization

### Enable Caching

Traefik automatically handles caching for static assets.

### Optimize Images

```bash
# Install image optimization tools
sudo apt-get install jpegoptim optipng

# Optimize images
find static -name "*.jpg" -exec jpegoptim --strip-all {} \;
find static -name "*.png" -exec optipng -o7 {} \;
```

### CDN Integration

Use Cloudflare for additional CDN:

1. Add site to Cloudflare
2. Update nameservers
3. Enable proxy (orange cloud)
4. Configure SSL: **Full (strict)**
5. Enable caching rules

---

## ðŸŽ¯ Next Steps

1. âœ… Configure DNS
2. âœ… Wait for SSL certificates
3. âœ… Login to admin panel
4. âœ… Create first post
5. âœ… Setup monitoring
6. âœ… Configure analytics
7. âœ… Setup GitHub webhook
8. âœ… Configure backups
9. âœ… Customize theme
10. âœ… Start blogging!

---

## ðŸ“š Additional Resources

- **Hugo Documentation:** https://gohugo.io/documentation/
- **Docker Documentation:** https://docs.docker.com/
- **Traefik Documentation:** https://doc.traefik.io/traefik/
- **Let's Encrypt:** https://letsencrypt.org/
- **GitHub Repository:** https://github.com/sileade/hugo-narrow-cms

---

## ðŸ’¬ Support

- **Issues:** https://github.com/sileade/hugo-narrow-cms/issues
- **Discussions:** https://github.com/sileade/hugo-narrow-cms/discussions

---

## ðŸ“ License

MIT License - see [LICENSE](LICENSE) file for details.

---

**Happy self-hosting! ðŸŽ‰**
