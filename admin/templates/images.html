{% extends "base.html" %}

{% block title %}Images - Hugo Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-images me-2"></i>Image Gallery</h1>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
        <i class="bi bi-cloud-upload me-1"></i> Upload Image
    </button>
</div>

{% if images %}
<div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
    {% for image in images %}
    <div class="col">
        <div class="card h-100 image-card">
            <div class="card-img-top-wrapper" style="height: 150px; overflow: hidden; background: #f8f9fa;">
                <img src="{{ image.url }}" class="card-img-top" alt="{{ image.filename }}" 
                     style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;"
                     onclick="showImagePreview('{{ image.url }}', '{{ image.filename }}')">
            </div>
            <div class="card-body p-2">
                <p class="card-text small text-truncate mb-1" title="{{ image.filename }}">
                    {{ image.filename }}
                </p>
                <p class="card-text small text-muted mb-0">
                    {{ image.size_human }} â€¢ {{ image.modified }}
                </p>
            </div>
            <div class="card-footer bg-transparent p-2">
                <div class="btn-group w-100" role="group">
                    <button type="button" class="btn btn-sm btn-outline-primary" 
                            onclick="copyToClipboard('{{ image.url }}')" title="Copy URL">
                        <i class="bi bi-clipboard"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" 
                            onclick="copyMarkdown('{{ image.url }}', '{{ image.filename }}')" title="Copy Markdown">
                        <i class="bi bi-markdown"></i>
                    </button>
                    <a href="{{ image.url }}" download class="btn btn-sm btn-outline-info" title="Download">
                        <i class="bi bi-download"></i>
                    </a>
                    <button type="button" class="btn btn-sm btn-outline-danger" 
                            onclick="deleteImage('{{ image.filename }}')" title="Delete">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="text-center py-5">
    <i class="bi bi-images display-1 text-muted"></i>
    <h3 class="mt-3 text-muted">No images uploaded yet</h3>
    <p class="text-muted">Click "Upload Image" to add your first image</p>
</div>
{% endif %}

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-cloud-upload me-2"></i>Upload Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="dropZone" class="border border-2 border-dashed rounded p-5 text-center mb-3"
                     style="cursor: pointer; transition: all 0.3s;">
                    <i class="bi bi-cloud-upload display-4 text-muted"></i>
                    <p class="mt-2 mb-0">Drag & drop images here or click to browse</p>
                    <small class="text-muted">Supported: PNG, JPG, JPEG, GIF, WebP, SVG, ICO</small>
                    <input type="file" id="fileInput" accept="image/*" multiple style="display: none;">
                </div>
                <div id="uploadProgress" style="display: none;">
                    <div class="progress mb-2">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%"></div>
                    </div>
                    <p class="text-center small text-muted" id="uploadStatus">Uploading...</p>
                </div>
                <div id="uploadResults"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Image Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewTitle">Image Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-0">
                <img id="previewImage" src="" alt="" style="max-width: 100%; max-height: 70vh;">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary" onclick="copyToClipboard(document.getElementById('previewImage').src)">
                    <i class="bi bi-clipboard me-1"></i> Copy URL
                </button>
                <a id="previewDownload" href="" download class="btn btn-outline-info">
                    <i class="bi bi-download me-1"></i> Download
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger"><i class="bi bi-exclamation-triangle me-2"></i>Delete Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this image?</p>
                <p class="text-muted" id="deleteFilename"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteForm" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const uploadProgress = document.getElementById('uploadProgress');
const progressBar = uploadProgress.querySelector('.progress-bar');
const uploadStatus = document.getElementById('uploadStatus');
const uploadResults = document.getElementById('uploadResults');

// Click to browse
dropZone.addEventListener('click', () => fileInput.click());

// Drag and drop
dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('border-primary', 'bg-light');
});

dropZone.addEventListener('dragleave', (e) => {
    e.preventDefault();
    dropZone.classList.remove('border-primary', 'bg-light');
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('border-primary', 'bg-light');
    const files = e.dataTransfer.files;
    uploadFiles(files);
});

fileInput.addEventListener('change', () => {
    uploadFiles(fileInput.files);
});

function uploadFiles(files) {
    if (files.length === 0) return;
    
    uploadProgress.style.display = 'block';
    uploadResults.innerHTML = '';
    
    let completed = 0;
    const total = files.length;
    
    Array.from(files).forEach((file, index) => {
        const formData = new FormData();
        formData.append('file', file);
        
        fetch('{{ admin_url("/upload") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            completed++;
            progressBar.style.width = (completed / total * 100) + '%';
            uploadStatus.textContent = `Uploaded ${completed} of ${total}`;
            
            if (data.success) {
                uploadResults.innerHTML += `
                    <div class="alert alert-success py-2 mb-2">
                        <i class="bi bi-check-circle me-1"></i>
                        ${file.name} uploaded successfully
                        <button class="btn btn-sm btn-outline-success float-end" onclick="copyToClipboard('${data.url}')">
                            Copy URL
                        </button>
                    </div>`;
            } else {
                uploadResults.innerHTML += `
                    <div class="alert alert-danger py-2 mb-2">
                        <i class="bi bi-x-circle me-1"></i>
                        ${file.name}: ${data.error}
                    </div>`;
            }
            
            if (completed === total) {
                setTimeout(() => {
                    location.reload();
                }, 1500);
            }
        })
        .catch(error => {
            completed++;
            uploadResults.innerHTML += `
                <div class="alert alert-danger py-2 mb-2">
                    <i class="bi bi-x-circle me-1"></i>
                    ${file.name}: Upload failed
                </div>`;
        });
    });
}

function showImagePreview(url, filename) {
    document.getElementById('previewImage').src = url;
    document.getElementById('previewTitle').textContent = filename;
    document.getElementById('previewDownload').href = url;
    new bootstrap.Modal(document.getElementById('previewModal')).show();
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showToast('URL copied to clipboard!');
    });
}

function copyMarkdown(url, filename) {
    const markdown = `![${filename}](${url})`;
    navigator.clipboard.writeText(markdown).then(() => {
        showToast('Markdown copied to clipboard!');
    });
}

function deleteImage(filename) {
    document.getElementById('deleteFilename').textContent = filename;
    document.getElementById('deleteForm').action = '{{ admin_url("/images/delete/") }}' + filename;
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

function showToast(message) {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = 'position-fixed bottom-0 end-0 p-3';
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        <div class="toast show" role="alert">
            <div class="toast-body">
                <i class="bi bi-check-circle text-success me-1"></i>
                ${message}
            </div>
        </div>`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}
</script>
{% endblock %}
