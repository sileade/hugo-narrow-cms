{% extends "base.html" %}
{% block title %}{{ 'Edit' if post else 'New' }} Post - Hugo CMS{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="bi bi-{{ 'pencil' if post else 'plus-circle' }} me-2"></i>
        {{ 'Edit Post' if post else 'New Post' }}
    </h2>
    <a href="{{ admin_url('/posts') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i> Back to Posts
    </a>
</div>

<form method="POST" action="{{ admin_url('/posts/edit/' + post.filename) if post else admin_url('/posts/new') }}" id="postForm">
    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-file-text me-2"></i>Content
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Title <span class="text-danger">*</span></label>
                        <input type="text" name="title" class="form-control form-control-lg" 
                               value="{{ post.title if post else '' }}" required 
                               placeholder="Enter post title...">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Content (Markdown)</label>
                        <textarea name="content" id="content" class="form-control" rows="20">{{ post.content if post else '' }}</textarea>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-gear me-2"></i>Settings
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Slug (URL)</label>
                        <input type="text" name="slug" class="form-control" 
                               value="{{ post.filename[:-3] if post else '' }}"
                               placeholder="auto-generated-from-title"
                               {% if post %}readonly{% endif %}>
                        <small class="text-muted">Leave empty to auto-generate from title</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea name="description" class="form-control" rows="3" 
                                  placeholder="Brief description for SEO...">{{ post.description if post else '' }}</textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Tags</label>
                        <input type="text" name="tags" class="form-control" 
                               value="{{ post.tags if post else '' }}"
                               placeholder="tag1, tag2, tag3">
                        <small class="text-muted">Comma-separated</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Categories</label>
                        <input type="text" name="categories" class="form-control" 
                               value="{{ post.categories if post else '' }}"
                               placeholder="category1, category2">
                        <small class="text-muted">Comma-separated</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Featured Image</label>
                        <div class="input-group">
                            <input type="text" name="image" id="imageUrl" class="form-control" 
                                   value="{{ post.image if post else '' }}"
                                   placeholder="/uploads/image.jpg">
                            <button type="button" class="btn btn-outline-secondary" onclick="openImagePicker()">
                                <i class="bi bi-images"></i>
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="openUploadModal()">
                                <i class="bi bi-upload"></i>
                            </button>
                        </div>
                        <div id="imagePreview" class="mt-2" style="display: none;">
                            <img id="previewImg" src="" alt="Preview" style="max-width: 100%; max-height: 150px; border-radius: 8px;">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="draft" id="draft"
                                   {% if post and post.draft %}checked{% endif %}>
                            <label class="form-check-label" for="draft">Save as Draft</label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-save me-2"></i>Actions
                </div>
                <div class="card-body">
                    <button type="submit" class="btn btn-primary w-100 mb-2">
                        <i class="bi bi-check-lg me-1"></i> {{ 'Update Post' if post else 'Create Post' }}
                    </button>
                    <button type="button" class="btn btn-outline-secondary w-100" onclick="previewPost()">
                        <i class="bi bi-eye me-1"></i> Preview
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-markdown me-2"></i>Markdown Help
                </div>
                <div class="card-body">
                    <small class="text-muted">
                        <code># Heading 1</code><br>
                        <code>## Heading 2</code><br>
                        <code>**bold**</code> / <code>*italic*</code><br>
                        <code>[link](url)</code><br>
                        <code>![image](url)</code><br>
                        <code>`code`</code><br>
                        <code>```language</code> for code blocks<br>
                        <code>- list item</code><br>
                        <code>1. numbered item</code><br>
                        <code>> blockquote</code>
                    </small>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Image Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-cloud-upload me-2"></i>Upload Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="dropZone" class="border border-2 border-dashed rounded p-4 text-center"
                     style="cursor: pointer;">
                    <i class="bi bi-cloud-upload display-4 text-muted"></i>
                    <p class="mt-2 mb-0">Drag & drop or click to upload</p>
                    <input type="file" id="fileInput" accept="image/*" style="display: none;">
                </div>
                <div id="uploadProgress" class="mt-3" style="display: none;">
                    <div class="progress">
                        <div class="progress-bar" style="width: 0%"></div>
                    </div>
                </div>
                <div id="uploadResult" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- Image Picker Modal -->
<div class="modal fade" id="imagePickerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-images me-2"></i>Select Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="imageGallery" class="row g-2">
                    <div class="text-center py-4">
                        <div class="spinner-border" role="status"></div>
                        <p class="mt-2">Loading images...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="previewContent" class="prose"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Initialize EasyMDE Markdown Editor
var easyMDE = new EasyMDE({
    element: document.getElementById('content'),
    spellChecker: false,
    autosave: {
        enabled: true,
        uniqueId: "post-{{ post.filename if post else 'new' }}",
        delay: 1000,
    },
    toolbar: [
        "bold", "italic", "heading", "|",
        "quote", "unordered-list", "ordered-list", "|",
        "link", "image", "code", "|",
        "preview", "side-by-side", "fullscreen", "|",
        "guide"
    ],
    placeholder: "Write your post content in Markdown...",
    minHeight: "400px",
});

function previewPost() {
    var content = easyMDE.value();
    fetch('{{ admin_url("/preview") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({content: content})
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('previewContent').innerHTML = data.html;
        new bootstrap.Modal(document.getElementById('previewModal')).show();
    });
}

// Auto-generate slug from title
document.querySelector('input[name="title"]').addEventListener('blur', function() {
    var slugInput = document.querySelector('input[name="slug"]');
    if (!slugInput.readOnly && !slugInput.value) {
        slugInput.value = this.value.toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-|-$/g, '');
    }
});

// Image URL preview
var imageUrlInput = document.getElementById('imageUrl');
var imagePreview = document.getElementById('imagePreview');
var previewImg = document.getElementById('previewImg');

if (imageUrlInput.value) {
    previewImg.src = imageUrlInput.value;
    imagePreview.style.display = 'block';
}

imageUrlInput.addEventListener('input', function() {
    if (this.value) {
        previewImg.src = this.value;
        imagePreview.style.display = 'block';
    } else {
        imagePreview.style.display = 'none';
    }
});

// Upload Modal
var uploadModal;
function openUploadModal() {
    uploadModal = new bootstrap.Modal(document.getElementById('uploadModal'));
    uploadModal.show();
}

var dropZone = document.getElementById('dropZone');
var fileInput = document.getElementById('fileInput');

dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('border-primary');
});
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('border-primary'));
dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('border-primary');
    uploadFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', () => uploadFile(fileInput.files[0]));

function uploadFile(file) {
    if (!file) return;
    
    var formData = new FormData();
    formData.append('file', file);
    
    document.getElementById('uploadProgress').style.display = 'block';
    document.querySelector('#uploadProgress .progress-bar').style.width = '50%';
    
    fetch('{{ admin_url("/upload") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        document.querySelector('#uploadProgress .progress-bar').style.width = '100%';
        if (data.success) {
            document.getElementById('uploadResult').innerHTML = 
                '<div class="alert alert-success">Uploaded! URL: <code>' + data.url + '</code></div>';
            imageUrlInput.value = data.url;
            previewImg.src = data.url;
            imagePreview.style.display = 'block';
            setTimeout(() => uploadModal.hide(), 1500);
        } else {
            document.getElementById('uploadResult').innerHTML = 
                '<div class="alert alert-danger">' + data.error + '</div>';
        }
    })
    .catch(error => {
        document.getElementById('uploadResult').innerHTML = 
            '<div class="alert alert-danger">Upload failed</div>';
    });
}

// Image Picker
function openImagePicker() {
    var modal = new bootstrap.Modal(document.getElementById('imagePickerModal'));
    modal.show();
    loadImageGallery();
}

function loadImageGallery() {
    // Fetch images from server (we'll create a simple endpoint)
    fetch('{{ admin_url("/api/images") }}')
    .then(response => response.json())
    .then(data => {
        var gallery = document.getElementById('imageGallery');
        if (data.images && data.images.length > 0) {
            gallery.innerHTML = data.images.map(img => 
                '<div class="col-4 col-md-3">' +
                '<div class="card" style="cursor: pointer;" onclick="selectImage(\'' + img.url + '\')">' +
                '<img src="' + img.url + '" class="card-img-top" style="height: 80px; object-fit: cover;">' +
                '</div></div>'
            ).join('');
        } else {
            gallery.innerHTML = '<div class="col-12 text-center py-4 text-muted">No images uploaded yet</div>';
        }
    })
    .catch(() => {
        document.getElementById('imageGallery').innerHTML = 
            '<div class="col-12 text-center py-4 text-muted">Failed to load images</div>';
    });
}

function selectImage(url) {
    imageUrlInput.value = url;
    previewImg.src = url;
    imagePreview.style.display = 'block';
    bootstrap.Modal.getInstance(document.getElementById('imagePickerModal')).hide();
}
</script>
{% endblock %}
