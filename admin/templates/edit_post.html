{% extends "base.html" %}

{% block title %}{{ 'Edit Post' if post else 'New Post' }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
<style>
* { box-sizing: border-box; }

.editor-page {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 60px);
    margin: -1.5rem;
    background: #fff;
}

/* Top Toolbar - StackEdit style */
.editor-toolbar {
    display: flex;
    align-items: center;
    height: 44px;
    padding: 0 8px;
    background: #f8f9fa;
    border-bottom: 1px solid #e0e0e0;
    flex-shrink: 0;
}

.toolbar-left {
    display: flex;
    align-items: center;
    gap: 4px;
}

.toolbar-center {
    display: flex;
    align-items: center;
    gap: 2px;
    margin-left: 16px;
    padding-left: 16px;
    border-left: 1px solid #e0e0e0;
}

.toolbar-right {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: auto;
}

.toolbar-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border: none;
    background: transparent;
    color: #5f6368;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.15s;
}

.toolbar-btn:hover {
    background: #e8eaed;
    color: #202124;
}

.toolbar-btn.active {
    background: #e8f0fe;
    color: #1a73e8;
}

.toolbar-divider {
    width: 1px;
    height: 24px;
    background: #e0e0e0;
    margin: 0 4px;
}

.file-name-input {
    border: none;
    background: transparent;
    font-size: 14px;
    font-weight: 500;
    color: #202124;
    padding: 4px 8px;
    border-radius: 4px;
    width: 200px;
}

.file-name-input:hover {
    background: #f1f3f4;
}

.file-name-input:focus {
    background: #fff;
    outline: 2px solid #1a73e8;
}

/* Main Editor Area */
.editor-main {
    display: flex;
    flex: 1;
    overflow: hidden;
}

/* Editor Pane (Left) */
.editor-pane {
    flex: 1;
    display: flex;
    flex-direction: column;
    border-right: 1px solid #e0e0e0;
    background: #fff;
    min-width: 0;
}

.CodeMirror {
    flex: 1;
    height: auto !important;
    font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
    font-size: 14px;
    line-height: 1.6;
    padding: 16px 0;
}

.CodeMirror-lines {
    padding: 0 20px;
}

.CodeMirror-scroll {
    padding-bottom: 50px;
}

.CodeMirror-gutters {
    background: #fff;
    border-right: none;
}

.CodeMirror-linenumber {
    color: #bbb;
    padding: 0 8px;
}

/* Preview Pane (Right) */
.preview-pane {
    flex: 1;
    overflow-y: auto;
    background: #fff;
    padding: 20px 40px;
    min-width: 0;
}

.preview-content {
    max-width: 800px;
    margin: 0 auto;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    font-size: 16px;
    line-height: 1.8;
    color: #202124;
}

.preview-content h1 {
    font-size: 2em;
    font-weight: 600;
    margin: 1em 0 0.5em;
    padding-bottom: 0.3em;
    border-bottom: 1px solid #eaecef;
    color: #202124;
}

.preview-content h2 {
    font-size: 1.5em;
    font-weight: 600;
    margin: 1em 0 0.5em;
    padding-bottom: 0.3em;
    border-bottom: 1px solid #eaecef;
    color: #202124;
}

.preview-content h3 { font-size: 1.25em; font-weight: 600; margin: 1em 0 0.5em; }
.preview-content h4 { font-size: 1em; font-weight: 600; margin: 1em 0 0.5em; }
.preview-content p { margin: 1em 0; }
.preview-content a { color: #1a73e8; text-decoration: none; }
.preview-content a:hover { text-decoration: underline; }

.preview-content code {
    background: #f1f3f4;
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'SF Mono', monospace;
    font-size: 0.9em;
    color: #d73a49;
}

.preview-content pre {
    background: #f6f8fa;
    padding: 16px;
    border-radius: 6px;
    overflow-x: auto;
    margin: 1em 0;
}

.preview-content pre code {
    background: none;
    padding: 0;
    color: inherit;
}

.preview-content blockquote {
    border-left: 4px solid #dfe2e5;
    margin: 1em 0;
    padding: 0 1em;
    color: #6a737d;
}

.preview-content ul, .preview-content ol {
    padding-left: 2em;
    margin: 1em 0;
}

.preview-content li { margin: 0.5em 0; }

.preview-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 1em 0;
}

.preview-content th, .preview-content td {
    border: 1px solid #dfe2e5;
    padding: 8px 12px;
    text-align: left;
}

.preview-content th { background: #f6f8fa; font-weight: 600; }
.preview-content img { max-width: 100%; border-radius: 4px; }
.preview-content hr { border: none; border-top: 1px solid #eaecef; margin: 2em 0; }

/* Status Bar */
.status-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: 24px;
    padding: 0 12px;
    background: #f8f9fa;
    border-top: 1px solid #e0e0e0;
    font-size: 11px;
    color: #5f6368;
    flex-shrink: 0;
}

.status-left, .status-right {
    display: flex;
    align-items: center;
    gap: 16px;
}

.status-item {
    display: flex;
    align-items: center;
    gap: 4px;
}

/* Settings Panel */
.settings-toggle {
    position: fixed;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 24px;
    height: 60px;
    background: #f8f9fa;
    border: 1px solid #e0e0e0;
    border-right: none;
    border-radius: 4px 0 0 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #5f6368;
    z-index: 100;
}

.settings-toggle:hover {
    background: #e8eaed;
}

.settings-panel {
    position: fixed;
    right: -320px;
    top: 60px;
    width: 320px;
    height: calc(100vh - 60px);
    background: #fff;
    border-left: 1px solid #e0e0e0;
    box-shadow: -2px 0 8px rgba(0,0,0,0.1);
    transition: right 0.3s ease;
    z-index: 99;
    overflow-y: auto;
    padding: 20px;
}

.settings-panel.open {
    right: 0;
}

.settings-panel h5 {
    font-size: 14px;
    font-weight: 600;
    color: #202124;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.settings-panel .form-label {
    font-size: 12px;
    font-weight: 500;
    color: #5f6368;
    margin-bottom: 4px;
}

.settings-panel .form-control {
    font-size: 13px;
    border: 1px solid #dadce0;
    border-radius: 4px;
    padding: 8px 12px;
}

.settings-panel .form-control:focus {
    border-color: #1a73e8;
    box-shadow: 0 0 0 2px rgba(26,115,232,0.2);
}

.settings-panel .btn-primary {
    background: #1a73e8;
    border: none;
    font-size: 14px;
    font-weight: 500;
    padding: 10px 24px;
    border-radius: 4px;
}

.settings-panel .btn-primary:hover {
    background: #1557b0;
}

/* Pane Resizer */
.pane-resizer {
    width: 4px;
    background: #e0e0e0;
    cursor: col-resize;
    flex-shrink: 0;
}

.pane-resizer:hover {
    background: #1a73e8;
}

/* View mode classes */
.editor-main.mode-editor .preview-pane,
.editor-main.mode-editor .pane-resizer { display: none; }

.editor-main.mode-preview .editor-pane,
.editor-main.mode-preview .pane-resizer { display: none; }

/* Responsive */
@media (max-width: 768px) {
    .editor-main { flex-direction: column; }
    .editor-pane { border-right: none; border-bottom: 1px solid #e0e0e0; }
    .pane-resizer { display: none; }
    .settings-panel { width: 100%; right: -100%; }
}

/* Fullscreen mode */
.editor-page.fullscreen {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    height: 100vh;
    margin: 0;
    z-index: 9999;
}
</style>
{% endblock %}

{% block content %}
<div class="editor-page" id="editorPage">
    <!-- Top Toolbar -->
    <div class="editor-toolbar">
        <div class="toolbar-left">
            <a href="{{ admin_url('/posts') }}" class="toolbar-btn" title="Back to Posts">
                <i class="bi bi-arrow-left"></i>
            </a>
            <input type="text" class="file-name-input" id="postTitle" name="title" 
                   value="{{ post.title if post else '' }}" placeholder="Untitled" required>
        </div>
        
        <div class="toolbar-center">
            <button type="button" class="toolbar-btn" onclick="editor.undo()" title="Undo">
                <i class="bi bi-arrow-counterclockwise"></i>
            </button>
            <button type="button" class="toolbar-btn" onclick="editor.redo()" title="Redo">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
            
            <div class="toolbar-divider"></div>
            
            <button type="button" class="toolbar-btn" onclick="insertFormat('bold')" title="Bold (Ctrl+B)">
                <i class="bi bi-type-bold"></i>
            </button>
            <button type="button" class="toolbar-btn" onclick="insertFormat('italic')" title="Italic (Ctrl+I)">
                <i class="bi bi-type-italic"></i>
            </button>
            <button type="button" class="toolbar-btn" onclick="insertFormat('h1')" title="Heading">
                <i class="bi bi-type-h1"></i>
            </button>
            <button type="button" class="toolbar-btn" onclick="insertFormat('strikethrough')" title="Strikethrough">
                <i class="bi bi-type-strikethrough"></i>
            </button>
            
            <div class="toolbar-divider"></div>
            
            <button type="button" class="toolbar-btn" onclick="insertFormat('ul')" title="Bullet List">
                <i class="bi bi-list-ul"></i>
            </button>
            <button type="button" class="toolbar-btn" onclick="insertFormat('ol')" title="Numbered List">
                <i class="bi bi-list-ol"></i>
            </button>
            <button type="button" class="toolbar-btn" onclick="insertFormat('task')" title="Task List">
                <i class="bi bi-check2-square"></i>
            </button>
            <button type="button" class="toolbar-btn" onclick="insertFormat('quote')" title="Quote">
                <i class="bi bi-quote"></i>
            </button>
            
            <div class="toolbar-divider"></div>
            
            <button type="button" class="toolbar-btn" onclick="insertFormat('code')" title="Code">
                <i class="bi bi-code"></i>
            </button>
            <button type="button" class="toolbar-btn" onclick="insertFormat('codeblock')" title="Code Block">
                <i class="bi bi-code-square"></i>
            </button>
            <button type="button" class="toolbar-btn" onclick="insertFormat('table')" title="Table">
                <i class="bi bi-table"></i>
            </button>
            
            <div class="toolbar-divider"></div>
            
            <button type="button" class="toolbar-btn" onclick="insertFormat('link')" title="Link (Ctrl+K)">
                <i class="bi bi-link-45deg"></i>
            </button>
            <button type="button" class="toolbar-btn" onclick="insertFormat('image')" title="Image">
                <i class="bi bi-image"></i>
            </button>
        </div>
        
        <div class="toolbar-right">
            <button type="button" class="toolbar-btn" id="btnEditor" onclick="setViewMode('editor')" title="Editor Only">
                <i class="bi bi-code-slash"></i>
            </button>
            <button type="button" class="toolbar-btn active" id="btnSplit" onclick="setViewMode('split')" title="Split View">
                <i class="bi bi-layout-split"></i>
            </button>
            <button type="button" class="toolbar-btn" id="btnPreview" onclick="setViewMode('preview')" title="Preview Only">
                <i class="bi bi-eye"></i>
            </button>
            
            <div class="toolbar-divider"></div>
            
            <button type="button" class="toolbar-btn" onclick="toggleFullscreen()" title="Fullscreen">
                <i class="bi bi-fullscreen"></i>
            </button>
            <button type="button" class="toolbar-btn" onclick="toggleSettings()" title="Settings">
                <i class="bi bi-gear"></i>
            </button>
        </div>
    </div>
    
    <!-- Main Editor Area -->
    <div class="editor-main mode-split" id="editorMain">
        <div class="editor-pane">
            <textarea id="content" name="content">{{ post.content if post else '' }}</textarea>
        </div>
        <div class="pane-resizer" id="paneResizer"></div>
        <div class="preview-pane">
            <div class="preview-content" id="previewContent">
                <p style="color: #999; text-align: center; padding-top: 100px;">
                    Start typing to see preview...
                </p>
            </div>
        </div>
    </div>
    
    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-left">
            <span class="status-item"><strong>Markdown</strong></span>
            <span class="status-item" id="byteCount">0 bytes</span>
            <span class="status-item" id="wordCount">0 words</span>
            <span class="status-item" id="lineCount">0 lines</span>
            <span class="status-item" id="cursorPos">Ln 1, Col 0</span>
        </div>
        <div class="status-right">
            <span class="status-item"><strong>HTML</strong></span>
            <span class="status-item" id="htmlChars">0 characters</span>
            <span class="status-item" id="htmlWords">0 words</span>
        </div>
    </div>
</div>

<!-- Settings Panel -->
<div class="settings-panel" id="settingsPanel">
    <form method="POST" action="{{ admin_url('/posts/edit/' + post.filename) if post else admin_url('/posts/new') }}" id="postForm">
        <input type="hidden" name="title" id="hiddenTitle">
        <input type="hidden" name="content" id="hiddenContent">
        
        <h5><i class="bi bi-gear"></i> Post Settings</h5>
        
        <div class="mb-3">
            <label class="form-label">Slug (URL)</label>
            <input type="text" name="slug" class="form-control" 
                   value="{{ post.filename[:-3] if post else '' }}"
                   placeholder="auto-generated-from-title"
                   {% if post %}readonly{% endif %}>
            <small class="text-muted">Leave empty to auto-generate</small>
        </div>
        
        <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea name="description" class="form-control" rows="2" 
                      placeholder="Brief description for SEO...">{{ post.description if post else '' }}</textarea>
        </div>
        
        <div class="mb-3">
            <label class="form-label">Tags</label>
            <input type="text" name="tags" class="form-control" 
                   value="{{ post.tags if post else '' }}"
                   placeholder="tag1, tag2, tag3">
            <small class="text-muted">Comma-separated</small>
        </div>
        
        <div class="mb-3">
            <label class="form-label">Categories</label>
            <input type="text" name="categories" class="form-control" 
                   value="{{ post.categories if post else '' }}"
                   placeholder="category1, category2">
            <small class="text-muted">Comma-separated</small>
        </div>
        
        <div class="mb-3">
            <label class="form-label">Featured Image</label>
            <div class="input-group">
                <input type="text" name="image" id="imageUrl" class="form-control" 
                       value="{{ post.image if post else '' }}"
                       placeholder="/uploads/image.jpg">
                <button type="button" class="btn btn-outline-secondary" onclick="openImagePicker()">
                    <i class="bi bi-images"></i>
                </button>
            </div>
            <div id="imagePreview" class="mt-2" style="display: none;">
                <img id="previewImg" src="" alt="Preview" style="max-width: 100%; max-height: 80px; border-radius: 4px;">
            </div>
        </div>
        
        <div class="mb-4">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" name="draft" id="draft"
                       {% if post and post.draft %}checked{% endif %}>
                <label class="form-check-label" for="draft">Save as Draft</label>
            </div>
        </div>
        
        <button type="submit" class="btn btn-primary w-100 mb-2">
            <i class="bi bi-check-lg me-1"></i> {{ 'Update Post' if post else 'Create Post' }}
        </button>
        <button type="button" class="btn btn-outline-secondary w-100" onclick="previewInNewTab()">
            <i class="bi bi-box-arrow-up-right me-1"></i> Preview in New Tab
        </button>
    </form>
</div>

<!-- Image Picker Modal -->
<div class="modal fade" id="imagePickerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-images me-2"></i>Select Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="file" id="uploadInput" accept="image/*" class="form-control">
                </div>
                <div class="row g-2" id="imageGallery">Loading...</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/markdown/markdown.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/gfm/gfm.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/continuelist.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.0/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<script>
// Initialize CodeMirror
var editor = CodeMirror.fromTextArea(document.getElementById('content'), {
    mode: 'gfm',
    lineNumbers: true,
    lineWrapping: true,
    extraKeys: {
        "Enter": "newlineAndIndentContinueMarkdownList",
        "Ctrl-B": function() { insertFormat('bold'); },
        "Ctrl-I": function() { insertFormat('italic'); },
        "Ctrl-K": function() { insertFormat('link'); },
        "Ctrl-S": function(cm) { savePost(); },
        "F11": function() { toggleFullscreen(); }
    }
});

// Configure marked
marked.setOptions({
    highlight: function(code, lang) {
        if (lang && hljs.getLanguage(lang)) {
            return hljs.highlight(code, { language: lang }).value;
        }
        return hljs.highlightAuto(code).value;
    },
    breaks: true,
    gfm: true
});

// Update preview on change
var updateTimeout;
editor.on('change', function() {
    clearTimeout(updateTimeout);
    updateTimeout = setTimeout(updatePreview, 100);
    updateStats();
});

editor.on('cursorActivity', function() {
    var cursor = editor.getCursor();
    document.getElementById('cursorPos').textContent = 'Ln ' + (cursor.line + 1) + ', Col ' + cursor.ch;
});

function updatePreview() {
    var content = editor.getValue();
    var html = marked.parse(content);
    document.getElementById('previewContent').innerHTML = html;
    document.querySelectorAll('#previewContent pre code').forEach(function(block) {
        hljs.highlightElement(block);
    });
    
    // Update HTML stats
    var text = document.getElementById('previewContent').textContent;
    document.getElementById('htmlChars').textContent = html.length + ' characters';
    document.getElementById('htmlWords').textContent = (text.trim() ? text.trim().split(/\s+/).length : 0) + ' words';
}

function updateStats() {
    var content = editor.getValue();
    var bytes = new Blob([content]).size;
    var words = content.trim() ? content.trim().split(/\s+/).length : 0;
    var lines = editor.lineCount();
    
    document.getElementById('byteCount').textContent = bytes + ' bytes';
    document.getElementById('wordCount').textContent = words + ' words';
    document.getElementById('lineCount').textContent = lines + ' lines';
}

function insertFormat(type) {
    var selection = editor.getSelection();
    var cursor = editor.getCursor();
    var line = editor.getLine(cursor.line);
    
    var formats = {
        'bold': { before: '**', after: '**', placeholder: 'bold text' },
        'italic': { before: '*', after: '*', placeholder: 'italic text' },
        'strikethrough': { before: '~~', after: '~~', placeholder: 'strikethrough' },
        'code': { before: '`', after: '`', placeholder: 'code' },
        'h1': { before: '# ', after: '', placeholder: 'Heading', line: true },
        'h2': { before: '## ', after: '', placeholder: 'Heading', line: true },
        'h3': { before: '### ', after: '', placeholder: 'Heading', line: true },
        'ul': { before: '- ', after: '', placeholder: 'List item', line: true },
        'ol': { before: '1. ', after: '', placeholder: 'List item', line: true },
        'task': { before: '- [ ] ', after: '', placeholder: 'Task', line: true },
        'quote': { before: '> ', after: '', placeholder: 'Quote', line: true },
        'link': { before: '[', after: '](url)', placeholder: 'link text' },
        'image': { before: '![', after: '](image-url)', placeholder: 'alt text' },
        'codeblock': { before: '```\n', after: '\n```', placeholder: 'code' },
        'table': { before: '| Header | Header |\n|--------|--------|\n| Cell   | Cell   |\n', after: '', placeholder: '' }
    };
    
    var format = formats[type];
    if (!format) return;
    
    if (format.line) {
        var newLine = format.before + (selection || format.placeholder);
        editor.replaceRange(newLine, {line: cursor.line, ch: 0}, {line: cursor.line, ch: line.length});
    } else {
        if (selection) {
            editor.replaceSelection(format.before + selection + format.after);
        } else {
            var text = format.before + format.placeholder + format.after;
            editor.replaceSelection(text);
            var newCursor = editor.getCursor();
            editor.setSelection(
                {line: newCursor.line, ch: newCursor.ch - format.after.length - format.placeholder.length},
                {line: newCursor.line, ch: newCursor.ch - format.after.length}
            );
        }
    }
    editor.focus();
}

function setViewMode(mode) {
    var main = document.getElementById('editorMain');
    main.className = 'editor-main mode-' + mode;
    
    document.getElementById('btnEditor').classList.remove('active');
    document.getElementById('btnSplit').classList.remove('active');
    document.getElementById('btnPreview').classList.remove('active');
    document.getElementById('btn' + mode.charAt(0).toUpperCase() + mode.slice(1)).classList.add('active');
    
    if (mode !== 'editor') updatePreview();
    setTimeout(function() { editor.refresh(); }, 10);
}

function toggleFullscreen() {
    document.getElementById('editorPage').classList.toggle('fullscreen');
    editor.refresh();
}

function toggleSettings() {
    document.getElementById('settingsPanel').classList.toggle('open');
}

function savePost() {
    document.getElementById('hiddenTitle').value = document.getElementById('postTitle').value;
    document.getElementById('hiddenContent').value = editor.getValue();
    document.getElementById('postForm').submit();
}

function previewInNewTab() {
    var content = editor.getValue();
    var html = marked.parse(content);
    var title = document.getElementById('postTitle').value || 'Preview';
    var w = window.open('', '_blank');
    w.document.write('<!DOCTYPE html><html><head><title>' + title + '</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css"><style>body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;max-width:800px;margin:40px auto;padding:20px;line-height:1.8;}pre{background:#f6f8fa;padding:16px;border-radius:6px;overflow-x:auto;}code{background:#f6f8fa;padding:2px 6px;border-radius:3px;}pre code{background:none;padding:0;}blockquote{border-left:4px solid #ddd;margin:1em 0;padding:0.5em 1em;color:#666;}table{border-collapse:collapse;width:100%;}th,td{border:1px solid #ddd;padding:8px 12px;}th{background:#f6f8fa;}</style></head><body><h1>' + title + '</h1>' + html + '<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"><\/script><script>hljs.highlightAll();<\/script></body></html>');
    w.document.close();
}

// Image handling
var imageUrlInput = document.getElementById('imageUrl');
var imagePreview = document.getElementById('imagePreview');
var previewImg = document.getElementById('previewImg');

if (imageUrlInput.value) {
    previewImg.src = imageUrlInput.value;
    imagePreview.style.display = 'block';
}

imageUrlInput.addEventListener('input', function() {
    if (this.value) {
        previewImg.src = this.value;
        imagePreview.style.display = 'block';
    } else {
        imagePreview.style.display = 'none';
    }
});

function openImagePicker() {
    new bootstrap.Modal(document.getElementById('imagePickerModal')).show();
    loadImageGallery();
}

function loadImageGallery() {
    fetch('{{ admin_url("/api/images") }}')
    .then(function(r) { return r.json(); })
    .then(function(data) {
        var gallery = document.getElementById('imageGallery');
        if (data.images && data.images.length > 0) {
            gallery.innerHTML = data.images.map(function(img) {
                return '<div class="col-4 col-md-3"><div class="card" style="cursor:pointer;" onclick="selectImage(\'' + img.url + '\')"><img src="' + img.url + '" class="card-img-top" style="height:80px;object-fit:cover;"></div></div>';
            }).join('');
        } else {
            gallery.innerHTML = '<div class="col-12 text-center py-4 text-muted">No images uploaded yet</div>';
        }
    });
}

function selectImage(url) {
    imageUrlInput.value = url;
    previewImg.src = url;
    imagePreview.style.display = 'block';
    bootstrap.Modal.getInstance(document.getElementById('imagePickerModal')).hide();
}

document.getElementById('uploadInput').addEventListener('change', function() {
    var file = this.files[0];
    if (!file) return;
    var formData = new FormData();
    formData.append('file', file);
    fetch('{{ admin_url("/upload") }}', { method: 'POST', body: formData })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            loadImageGallery();
            selectImage(data.url);
        }
    });
});

// Pane resizer
var resizer = document.getElementById('paneResizer');
var editorPane = document.querySelector('.editor-pane');
var previewPane = document.querySelector('.preview-pane');
var isResizing = false;

resizer.addEventListener('mousedown', function(e) {
    isResizing = true;
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
});

document.addEventListener('mousemove', function(e) {
    if (!isResizing) return;
    var main = document.getElementById('editorMain');
    var rect = main.getBoundingClientRect();
    var pct = ((e.clientX - rect.left) / rect.width) * 100;
    if (pct > 20 && pct < 80) {
        editorPane.style.flex = '0 0 ' + pct + '%';
        previewPane.style.flex = '0 0 ' + (100 - pct) + '%';
    }
});

document.addEventListener('mouseup', function() {
    if (isResizing) {
        isResizing = false;
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
        editor.refresh();
    }
});

// Auto-generate slug from title
document.getElementById('postTitle').addEventListener('blur', function() {
    var slugInput = document.querySelector('input[name="slug"]');
    if (!slugInput.readOnly && !slugInput.value) {
        slugInput.value = this.value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
    }
});

// Form submission
document.getElementById('postForm').addEventListener('submit', function(e) {
    document.getElementById('hiddenTitle').value = document.getElementById('postTitle').value;
    document.getElementById('hiddenContent').value = editor.getValue();
});

// Paste image from clipboard
editor.getWrapperElement().addEventListener('paste', function(e) {
    var items = e.clipboardData.items;
    for (var i = 0; i < items.length; i++) {
        if (items[i].type.indexOf('image') !== -1) {
            e.preventDefault();
            var file = items[i].getAsFile();
            var formData = new FormData();
            formData.append('file', file);
            fetch('{{ admin_url("/upload") }}', { method: 'POST', body: formData })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success) {
                    editor.replaceSelection('![image](' + data.url + ')');
                }
            });
            break;
        }
    }
});

// Initialize
window.addEventListener('load', function() {
    updatePreview();
    updateStats();
    editor.refresh();
});
</script>
{% endblock %}
