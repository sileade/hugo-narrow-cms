{% extends "base.html" %}

{% block title %}{{ 'Edit Post' if post else 'New Post' }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
<style>
/* Page layout */
.editor-page {
    display: flex;
    gap: 20px;
    min-height: calc(100vh - 150px);
}

.editor-main {
    flex: 1;
    min-width: 0;
}

.editor-sidebar {
    width: 300px;
    flex-shrink: 0;
}

/* Title input */
.title-input {
    width: 100%;
    font-size: 24px;
    font-weight: 600;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    padding: 12px 16px;
    margin-bottom: 16px;
    transition: border-color 0.2s;
}

.title-input:focus {
    outline: none;
    border-color: #6366f1;
}

/* EasyMDE customization */
.EasyMDEContainer {
    border-radius: 8px;
    overflow: hidden;
}

.EasyMDEContainer .CodeMirror {
    border: 2px solid #e5e7eb;
    border-top: none;
    border-radius: 0 0 8px 8px;
    min-height: 500px;
    font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
    font-size: 14px;
    line-height: 1.6;
}

.EasyMDEContainer .CodeMirror-focused {
    border-color: #6366f1;
}

.editor-toolbar {
    border: 2px solid #e5e7eb;
    border-radius: 8px 8px 0 0;
    background: #f9fafb;
    padding: 8px;
}

.editor-toolbar button {
    border: none !important;
    background: transparent;
    color: #4b5563;
    border-radius: 4px;
    padding: 6px 10px;
    margin: 0 2px;
}

.editor-toolbar button:hover {
    background: #e5e7eb;
    color: #1f2937;
}

.editor-toolbar button.active {
    background: #dbeafe;
    color: #2563eb;
}

.editor-toolbar i.separator {
    border-left: 1px solid #d1d5db;
    margin: 0 8px;
}

/* Preview styling */
.editor-preview {
    background: #fff;
    padding: 20px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-size: 16px;
    line-height: 1.8;
}

.editor-preview h1 { font-size: 2em; font-weight: 700; margin: 0.67em 0; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.3em; }
.editor-preview h2 { font-size: 1.5em; font-weight: 600; margin: 1em 0 0.5em; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.3em; }
.editor-preview h3 { font-size: 1.25em; font-weight: 600; margin: 1em 0 0.5em; }
.editor-preview code { background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-size: 0.9em; }
.editor-preview pre { background: #f3f4f6; padding: 16px; border-radius: 8px; overflow-x: auto; }
.editor-preview pre code { background: none; padding: 0; }
.editor-preview blockquote { border-left: 4px solid #d1d5db; margin: 1em 0; padding: 0 1em; color: #6b7280; }
.editor-preview table { width: 100%; border-collapse: collapse; margin: 1em 0; }
.editor-preview th, .editor-preview td { border: 1px solid #e5e7eb; padding: 8px 12px; }
.editor-preview th { background: #f9fafb; font-weight: 600; }
.editor-preview img { max-width: 100%; border-radius: 8px; }

/* Sidebar card */
.settings-card {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    overflow: hidden;
}

.settings-card .card-header {
    background: #f9fafb;
    padding: 12px 16px;
    font-weight: 600;
    font-size: 14px;
    border-bottom: 1px solid #e5e7eb;
}

.settings-card .card-body {
    padding: 16px;
}

.settings-card .form-label {
    font-size: 13px;
    font-weight: 500;
    color: #374151;
    margin-bottom: 4px;
}

.settings-card .form-control {
    font-size: 13px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    padding: 8px 12px;
}

.settings-card .form-control:focus {
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.settings-card .form-text {
    font-size: 11px;
    color: #9ca3af;
}

/* Buttons */
.btn-publish {
    width: 100%;
    padding: 12px 16px;
    font-size: 14px;
    font-weight: 600;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    border: none;
    border-radius: 8px;
    color: #fff;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-publish:hover {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    transform: translateY(-1px);
}

.btn-preview-link {
    width: 100%;
    padding: 10px 16px;
    font-size: 14px;
    background: #fff;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    color: #374151;
    cursor: pointer;
    margin-top: 8px;
}

.btn-preview-link:hover {
    background: #f9fafb;
    border-color: #9ca3af;
}

/* Featured Image Box */
.featured-image-box {
    border: 2px dashed #d1d5db;
    border-radius: 8px;
    padding: 12px;
    background: #f9fafb;
}

.image-preview-large {
    width: 100%;
    height: 150px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #fff;
    border-radius: 6px;
    overflow: hidden;
    margin-bottom: 10px;
}

.image-preview-large img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}

.image-preview-large .no-image {
    display: flex;
    flex-direction: column;
    align-items: center;
    color: #9ca3af;
    font-size: 12px;
}

.image-preview-large .no-image i {
    font-size: 32px;
    margin-bottom: 4px;
}

.image-actions {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}

.image-actions .btn {
    font-size: 11px;
    padding: 4px 8px;
}

/* Status indicator */
.autosave-status {
    font-size: 12px;
    color: #6b7280;
    padding: 8px 16px;
    text-align: center;
    border-top: 1px solid #e5e7eb;
}

.autosave-status.saving { color: #f59e0b; }
.autosave-status.saved { color: #10b981; }
.autosave-status.error { color: #ef4444; }

/* Responsive */
@media (max-width: 1024px) {
    .editor-page {
        flex-direction: column;
    }
    .editor-sidebar {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0">
        <i class="bi bi-pencil-square me-2"></i>
        {{ 'Edit Post' if post else 'New Post' }}
    </h4>
    <a href="{{ admin_url('/posts') }}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left me-1"></i> Back to Posts
    </a>
</div>

<div class="editor-page">
    <!-- Main Editor Area -->
    <div class="editor-main">
        <input type="text" class="title-input" id="postTitle" 
               value="{{ post.title if post else '' }}" 
               placeholder="Enter post title..." required>
        
        <textarea id="content">{{ post.content if post else '' }}</textarea>
    </div>
    
    <!-- Sidebar -->
    <div class="editor-sidebar">
        <form method="POST" action="{{ admin_url('/posts/edit/' + post.filename) if post else admin_url('/posts/new') }}" id="postForm">
            <input type="hidden" name="title" id="hiddenTitle">
            <input type="hidden" name="content" id="hiddenContent">
            
            <div class="settings-card mb-3">
                <div class="card-header">
                    <i class="bi bi-gear me-2"></i>Post Settings
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Slug (URL)</label>
                        <input type="text" name="slug" class="form-control" 
                               value="{{ post.filename[:-3] if post else '' }}"
                               placeholder="auto-generated"
                               {% if post %}readonly{% endif %}>
                        <div class="form-text">Leave empty to auto-generate</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea name="description" class="form-control" rows="2" 
                                  placeholder="Brief description for SEO...">{{ post.description if post else '' }}</textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Tags</label>
                        <input type="text" name="tags" class="form-control" 
                               value="{{ post.tags if post else '' }}"
                               placeholder="tag1, tag2, tag3">
                        <div class="form-text">Comma-separated</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Categories</label>
                        <input type="text" name="categories" class="form-control" 
                               value="{{ post.categories if post else '' }}"
                               placeholder="category1, category2">
                        <div class="form-text">Comma-separated</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Featured Image</label>
                        <div class="featured-image-box">
                            <div class="image-preview-large" id="imagePreview">
                                <img id="previewImg" src="{{ post.image if post else '' }}" alt="Preview" style="display: {{ 'block' if post and post.image else 'none' }};">
                                <div class="no-image" id="noImagePlaceholder" style="display: {{ 'none' if post and post.image else 'flex' }};">
                                    <i class="bi bi-image"></i>
                                    <span>No image selected</span>
                                </div>
                            </div>
                            <div class="image-actions">
                                <input type="hidden" name="image" id="imageUrl" value="{{ post.image if post else '' }}">
                                <button type="button" class="btn btn-primary btn-sm" onclick="openImageUpload()">
                                    <i class="bi bi-upload me-1"></i> Upload
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="openImagePicker()">
                                    <i class="bi bi-folder2-open me-1"></i> Gallery
                                </button>
                                <button type="button" class="btn btn-outline-info btn-sm" onclick="extractFirstImage()" title="Use first image from post content">
                                    <i class="bi bi-magic me-1"></i> Auto
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="clearFeaturedImage()" id="clearImageBtn" style="display: {{ 'inline-block' if post and post.image else 'none' }};">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                            <div class="form-text mt-1">Upload, select from gallery, or auto-extract from post</div>
                        </div>
                    </div>
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" name="draft" id="draft"
                               {% if post and post.draft %}checked{% endif %}>
                        <label class="form-check-label" for="draft">Save as Draft</label>
                    </div>
                </div>
                
                <div class="autosave-status" id="autosaveStatus">
                    <i class="bi bi-cloud-check me-1"></i> Ready
                </div>
            </div>
            
            <button type="submit" class="btn-publish">
                <i class="bi bi-check-lg me-1"></i> {{ 'Update Post' if post else 'Create Post' }}
            </button>
            <button type="button" class="btn-preview-link" onclick="previewInNewTab()">
                <i class="bi bi-box-arrow-up-right me-1"></i> Preview
            </button>
        </form>
    </div>
</div>

<!-- Image Picker Modal -->
<div class="modal fade" id="imagePickerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-images me-2"></i>Select Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Upload New Image</label>
                    <input type="file" id="uploadInput" accept="image/*" class="form-control">
                </div>
                <hr>
                <label class="form-label">Or Select Existing</label>
                <div class="row g-2" id="imageGallery">Loading...</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
<script>
// Initialize EasyMDE
var easyMDE = new EasyMDE({
    element: document.getElementById('content'),
    spellChecker: false,
    autosave: {
        enabled: false
    },
    status: ['lines', 'words', 'cursor'],
    toolbar: [
        'bold', 'italic', 'strikethrough', 'heading', '|',
        'quote', 'unordered-list', 'ordered-list', 'task-list', '|',
        'link', 'image', 'table', 'horizontal-rule', '|',
        'code', 'preview', 'side-by-side', 'fullscreen', '|',
        'guide'
    ],
    sideBySideFullscreen: false,
    previewClass: ['editor-preview'],
    renderingConfig: {
        codeSyntaxHighlighting: true
    },
    minHeight: '400px',
    placeholder: 'Write your post content here...\n\nUse Markdown formatting:\n- **bold** for bold text\n- *italic* for italic text\n- # Heading for headers\n- [link](url) for links\n- ![alt](url) for images'
});

// Preview in new tab
function previewInNewTab() {
    var content = easyMDE.value();
    var title = document.getElementById('postTitle').value || 'Preview';
    var html = easyMDE.markdown(content);
    var w = window.open('', '_blank');
    w.document.write('<!DOCTYPE html><html><head><title>' + title + '</title><style>body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;max-width:800px;margin:40px auto;padding:20px;line-height:1.8;}h1{border-bottom:1px solid #eee;padding-bottom:10px;}pre{background:#f6f8fa;padding:16px;border-radius:6px;overflow-x:auto;}code{background:#f6f8fa;padding:2px 6px;border-radius:3px;}pre code{background:none;padding:0;}blockquote{border-left:4px solid #ddd;margin:1em 0;padding:0.5em 1em;color:#666;}table{border-collapse:collapse;width:100%;}th,td{border:1px solid #ddd;padding:8px 12px;}th{background:#f6f8fa;}</style></head><body><h1>' + title + '</h1>' + html + '</body></html>');
    w.document.close();
}

// Image handling
var imageUrlInput = document.getElementById('imageUrl');
var previewImg = document.getElementById('previewImg');
var noImagePlaceholder = document.getElementById('noImagePlaceholder');
var clearImageBtn = document.getElementById('clearImageBtn');

function updateImagePreview(url) {
    if (url) {
        previewImg.src = url;
        previewImg.style.display = 'block';
        noImagePlaceholder.style.display = 'none';
        clearImageBtn.style.display = 'inline-block';
        imageUrlInput.value = url;
    } else {
        previewImg.style.display = 'none';
        noImagePlaceholder.style.display = 'flex';
        clearImageBtn.style.display = 'none';
        imageUrlInput.value = '';
    }
}

function clearFeaturedImage() {
    updateImagePreview('');
}

function openImageUpload() {
    var input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = function(e) {
        var file = e.target.files[0];
        if (!file) return;
        var formData = new FormData();
        formData.append('file', file);
        fetch('{{ admin_url("/upload") }}', { method: 'POST', body: formData })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                updateImagePreview(data.url);
            } else {
                alert('Upload failed: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(function(err) {
            alert('Upload failed: ' + err.message);
        });
    };
    input.click();
}

function extractFirstImage() {
    var content = easyMDE.value();
    // Match markdown images: ![alt](url)
    var mdMatch = content.match(/!\[[^\]]*\]\(([^)]+)\)/);
    if (mdMatch && mdMatch[1]) {
        updateImagePreview(mdMatch[1]);
        return;
    }
    // Match HTML images: <img src="url">
    var htmlMatch = content.match(/<img[^>]+src=["']([^"']+)["']/);
    if (htmlMatch && htmlMatch[1]) {
        updateImagePreview(htmlMatch[1]);
        return;
    }
    alert('No images found in post content');
}

function openImagePicker() {
    new bootstrap.Modal(document.getElementById('imagePickerModal')).show();
    loadImageGallery();
}

function loadImageGallery() {
    fetch('{{ admin_url("/api/images") }}')
    .then(function(r) { return r.json(); })
    .then(function(data) {
        var gallery = document.getElementById('imageGallery');
        if (data.images && data.images.length > 0) {
            gallery.innerHTML = data.images.map(function(img) {
                return '<div class="col-4 col-md-3"><div class="card" style="cursor:pointer;" onclick="selectImage(\'' + img.url + '\')"><img src="' + img.url + '" class="card-img-top" style="height:80px;object-fit:cover;"></div></div>';
            }).join('');
        } else {
            gallery.innerHTML = '<div class="col-12 text-center py-4 text-muted">No images uploaded yet</div>';
        }
    });
}

function selectImage(url) {
    updateImagePreview(url);
    bootstrap.Modal.getInstance(document.getElementById('imagePickerModal')).hide();
}

document.getElementById('uploadInput').addEventListener('change', function() {
    var file = this.files[0];
    if (!file) return;
    var formData = new FormData();
    formData.append('file', file);
    fetch('{{ admin_url("/upload") }}', { method: 'POST', body: formData })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            loadImageGallery();
            selectImage(data.url);
        }
    });
});

// Auto-generate slug
document.getElementById('postTitle').addEventListener('blur', function() {
    var slugInput = document.querySelector('input[name="slug"]');
    if (!slugInput.readOnly && !slugInput.value) {
        slugInput.value = this.value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
    }
});

// Form submission
document.getElementById('postForm').addEventListener('submit', function(e) {
    document.getElementById('hiddenTitle').value = document.getElementById('postTitle').value;
    document.getElementById('hiddenContent').value = easyMDE.value();
});

// Auto-save functionality
var currentFilename = '{{ post.filename if post else "" }}';
var lastSavedContent = '';
var hasUnsavedChanges = false;

function getPostData() {
    return {
        title: document.getElementById('postTitle').value,
        content: easyMDE.value(),
        slug: document.querySelector('input[name="slug"]').value,
        description: document.querySelector('textarea[name="description"]').value,
        tags: document.querySelector('input[name="tags"]').value,
        categories: document.querySelector('input[name="categories"]').value,
        image: document.getElementById('imageUrl').value,
        filename: currentFilename || null
    };
}

function updateAutosaveStatus(status, message) {
    var el = document.getElementById('autosaveStatus');
    el.className = 'autosave-status ' + status;
    el.innerHTML = message;
}

function autoSave() {
    var data = getPostData();
    if (!data.title.trim()) return;
    
    var currentContent = JSON.stringify(data);
    if (currentContent === lastSavedContent) return;
    
    updateAutosaveStatus('saving', '<i class="bi bi-cloud-arrow-up me-1"></i> Saving...');
    
    fetch('{{ admin_url("/posts/autosave") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(function(r) { return r.json(); })
    .then(function(response) {
        if (response.success) {
            lastSavedContent = currentContent;
            hasUnsavedChanges = false;
            if (response.filename && !currentFilename) {
                currentFilename = response.filename;
            }
            updateAutosaveStatus('saved', '<i class="bi bi-cloud-check me-1"></i> Saved ' + response.timestamp);
        } else {
            updateAutosaveStatus('error', '<i class="bi bi-cloud-slash me-1"></i> Save failed');
        }
    })
    .catch(function() {
        updateAutosaveStatus('error', '<i class="bi bi-cloud-slash me-1"></i> Save failed');
    });
}

// Save to localStorage as backup
function saveToLocalStorage() {
    var data = getPostData();
    if (data.title || data.content) {
        localStorage.setItem('draft_' + (currentFilename || 'new'), JSON.stringify(data));
    }
}

// Track changes
easyMDE.codemirror.on('change', function() {
    hasUnsavedChanges = true;
    saveToLocalStorage();
});

document.getElementById('postTitle').addEventListener('input', function() {
    hasUnsavedChanges = true;
    saveToLocalStorage();
});

// Warn before leaving
window.addEventListener('beforeunload', function(e) {
    if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = '';
    }
});

// Clear localStorage on submit
document.getElementById('postForm').addEventListener('submit', function() {
    hasUnsavedChanges = false;
    localStorage.removeItem('draft_' + (currentFilename || 'new'));
});

// Start auto-save (every 30 seconds)
setInterval(autoSave, 30000);

// Initialize
lastSavedContent = JSON.stringify(getPostData());
</script>
{% endblock %}
