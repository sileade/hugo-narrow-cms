{% extends "base.html" %}

{% block title %}{{ 'Edit Post' if post else 'New Post' }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
<style>
/* Override base styles for editor page */
.editor-wrapper {
    margin: -2rem;
    height: calc(100vh - 0px);
    display: flex;
    flex-direction: column;
    background: #fff;
}

/* Header with title and back button */
.editor-header {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    background: #fff;
    border-bottom: 1px solid #e5e7eb;
    gap: 12px;
}

.editor-header .back-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: 8px;
    color: #6b7280;
    text-decoration: none;
    transition: all 0.15s;
}

.editor-header .back-btn:hover {
    background: #f3f4f6;
    color: #374151;
}

.editor-header .title-input {
    flex: 1;
    border: none;
    font-size: 18px;
    font-weight: 600;
    color: #111827;
    background: transparent;
    padding: 8px 12px;
    border-radius: 8px;
}

.editor-header .title-input:hover {
    background: #f9fafb;
}

.editor-header .title-input:focus {
    outline: none;
    background: #f3f4f6;
}

/* Toolbar */
.editor-toolbar-row {
    display: flex;
    align-items: center;
    padding: 8px 16px;
    background: #f9fafb;
    border-bottom: 1px solid #e5e7eb;
    gap: 4px;
    flex-wrap: wrap;
}

.toolbar-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 34px;
    height: 34px;
    border: none;
    background: transparent;
    color: #6b7280;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.15s;
}

.toolbar-btn:hover {
    background: #e5e7eb;
    color: #374151;
}

.toolbar-btn.active {
    background: #dbeafe;
    color: #2563eb;
}

.toolbar-sep {
    width: 1px;
    height: 24px;
    background: #d1d5db;
    margin: 0 8px;
}

.toolbar-spacer {
    flex: 1;
}

/* Main content area */
.editor-body {
    display: flex;
    flex: 1;
    overflow: hidden;
}

/* Left side - Editor + Preview */
.editor-left {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
}

/* Split panes container */
.split-container {
    display: flex;
    flex: 1;
    overflow: hidden;
}

/* Editor pane */
.editor-pane {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
    border-right: 1px solid #e5e7eb;
}

.CodeMirror {
    flex: 1;
    height: 100% !important;
    font-family: 'JetBrains Mono', 'Fira Code', 'SF Mono', Monaco, monospace;
    font-size: 14px;
    line-height: 1.6;
}

.CodeMirror-scroll {
    padding: 16px;
}

.CodeMirror-gutters {
    background: #fff;
    border-right: 1px solid #f3f4f6;
}

.CodeMirror-linenumber {
    color: #9ca3af;
    padding: 0 12px 0 8px;
}

/* Preview pane */
.preview-pane {
    flex: 1;
    overflow-y: auto;
    padding: 24px 32px;
    background: #fff;
    min-width: 0;
}

.preview-content {
    max-width: 720px;
    margin: 0 auto;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-size: 16px;
    line-height: 1.75;
    color: #1f2937;
}

.preview-content h1 { font-size: 2em; font-weight: 700; margin: 0.67em 0; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.3em; }
.preview-content h2 { font-size: 1.5em; font-weight: 600; margin: 1em 0 0.5em; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.3em; }
.preview-content h3 { font-size: 1.25em; font-weight: 600; margin: 1em 0 0.5em; }
.preview-content p { margin: 1em 0; }
.preview-content a { color: #2563eb; }
.preview-content code { background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-size: 0.9em; }
.preview-content pre { background: #f3f4f6; padding: 16px; border-radius: 8px; overflow-x: auto; }
.preview-content pre code { background: none; padding: 0; }
.preview-content blockquote { border-left: 4px solid #d1d5db; margin: 1em 0; padding: 0 1em; color: #6b7280; }
.preview-content ul, .preview-content ol { padding-left: 2em; }
.preview-content table { width: 100%; border-collapse: collapse; margin: 1em 0; }
.preview-content th, .preview-content td { border: 1px solid #e5e7eb; padding: 8px 12px; }
.preview-content th { background: #f9fafb; font-weight: 600; }
.preview-content img { max-width: 100%; border-radius: 8px; }
.preview-content hr { border: none; border-top: 1px solid #e5e7eb; margin: 2em 0; }

.preview-placeholder {
    color: #9ca3af;
    text-align: center;
    padding-top: 80px;
}

.preview-placeholder i {
    font-size: 48px;
    margin-bottom: 16px;
    display: block;
}

/* Resizer */
.pane-resizer {
    width: 4px;
    background: #e5e7eb;
    cursor: col-resize;
    flex-shrink: 0;
}

.pane-resizer:hover {
    background: #3b82f6;
}

/* Right sidebar - Settings */
.editor-sidebar {
    width: 300px;
    background: #f9fafb;
    border-left: 1px solid #e5e7eb;
    overflow-y: auto;
    flex-shrink: 0;
}

.sidebar-section {
    padding: 16px;
    border-bottom: 1px solid #e5e7eb;
}

.sidebar-section h6 {
    font-size: 12px;
    font-weight: 600;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 12px;
}

.sidebar-section .form-label {
    font-size: 13px;
    font-weight: 500;
    color: #374151;
    margin-bottom: 4px;
}

.sidebar-section .form-control {
    font-size: 13px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    padding: 8px 12px;
}

.sidebar-section .form-control:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.sidebar-section .form-text {
    font-size: 11px;
    color: #9ca3af;
}

.sidebar-section .btn-primary {
    width: 100%;
    padding: 10px 16px;
    font-size: 14px;
    font-weight: 500;
}

.sidebar-section .btn-outline-secondary {
    width: 100%;
    padding: 10px 16px;
    font-size: 14px;
}

/* Status bar */
.status-bar {
    display: flex;
    justify-content: space-between;
    padding: 6px 16px;
    background: #f9fafb;
    border-top: 1px solid #e5e7eb;
    font-size: 11px;
    color: #6b7280;
}

.status-bar .status-group {
    display: flex;
    gap: 16px;
}

.status-bar .status-item {
    display: flex;
    align-items: center;
    gap: 4px;
}

/* View mode classes */
.split-container.mode-editor .preview-pane,
.split-container.mode-editor .pane-resizer { display: none; }

.split-container.mode-preview .editor-pane,
.split-container.mode-preview .pane-resizer { display: none; }

/* Image preview */
.image-preview {
    margin-top: 8px;
}

.image-preview img {
    max-width: 100%;
    max-height: 100px;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
}

/* Responsive */
@media (max-width: 1024px) {
    .editor-sidebar { width: 260px; }
}

@media (max-width: 768px) {
    .editor-body { flex-direction: column; }
    .editor-sidebar { width: 100%; border-left: none; border-top: 1px solid #e5e7eb; }
    .split-container { flex-direction: column; }
    .editor-pane { border-right: none; border-bottom: 1px solid #e5e7eb; }
    .pane-resizer { display: none; }
}
</style>
{% endblock %}

{% block content %}
<div class="editor-wrapper">
    <!-- Header -->
    <div class="editor-header">
        <a href="{{ admin_url('/posts') }}" class="back-btn" title="Back to Posts">
            <i class="bi bi-arrow-left"></i>
        </a>
        <input type="text" class="title-input" id="postTitle" 
               value="{{ post.title if post else '' }}" 
               placeholder="Post title..." required>
    </div>
    
    <!-- Toolbar -->
    <div class="editor-toolbar-row">
        <button type="button" class="toolbar-btn" onclick="editor.undo()" title="Undo (Ctrl+Z)">
            <i class="bi bi-arrow-counterclockwise"></i>
        </button>
        <button type="button" class="toolbar-btn" onclick="editor.redo()" title="Redo (Ctrl+Y)">
            <i class="bi bi-arrow-clockwise"></i>
        </button>
        
        <span class="toolbar-sep"></span>
        
        <button type="button" class="toolbar-btn" onclick="insertFormat('bold')" title="Bold (Ctrl+B)">
            <i class="bi bi-type-bold"></i>
        </button>
        <button type="button" class="toolbar-btn" onclick="insertFormat('italic')" title="Italic (Ctrl+I)">
            <i class="bi bi-type-italic"></i>
        </button>
        <button type="button" class="toolbar-btn" onclick="insertFormat('strikethrough')" title="Strikethrough">
            <i class="bi bi-type-strikethrough"></i>
        </button>
        
        <span class="toolbar-sep"></span>
        
        <button type="button" class="toolbar-btn" onclick="insertFormat('h1')" title="Heading 1">
            <strong>H1</strong>
        </button>
        <button type="button" class="toolbar-btn" onclick="insertFormat('h2')" title="Heading 2">
            <strong>H2</strong>
        </button>
        <button type="button" class="toolbar-btn" onclick="insertFormat('h3')" title="Heading 3">
            <strong>H3</strong>
        </button>
        
        <span class="toolbar-sep"></span>
        
        <button type="button" class="toolbar-btn" onclick="insertFormat('ul')" title="Bullet List">
            <i class="bi bi-list-ul"></i>
        </button>
        <button type="button" class="toolbar-btn" onclick="insertFormat('ol')" title="Numbered List">
            <i class="bi bi-list-ol"></i>
        </button>
        <button type="button" class="toolbar-btn" onclick="insertFormat('task')" title="Task List">
            <i class="bi bi-check2-square"></i>
        </button>
        <button type="button" class="toolbar-btn" onclick="insertFormat('quote')" title="Quote">
            <i class="bi bi-quote"></i>
        </button>
        
        <span class="toolbar-sep"></span>
        
        <button type="button" class="toolbar-btn" onclick="insertFormat('code')" title="Inline Code">
            <i class="bi bi-code"></i>
        </button>
        <button type="button" class="toolbar-btn" onclick="insertFormat('codeblock')" title="Code Block">
            <i class="bi bi-code-square"></i>
        </button>
        <button type="button" class="toolbar-btn" onclick="insertFormat('table')" title="Table">
            <i class="bi bi-table"></i>
        </button>
        
        <span class="toolbar-sep"></span>
        
        <button type="button" class="toolbar-btn" onclick="insertFormat('link')" title="Link (Ctrl+K)">
            <i class="bi bi-link-45deg"></i>
        </button>
        <button type="button" class="toolbar-btn" onclick="insertFormat('image')" title="Image">
            <i class="bi bi-image"></i>
        </button>
        <button type="button" class="toolbar-btn" onclick="insertFormat('hr')" title="Horizontal Rule">
            <i class="bi bi-dash-lg"></i>
        </button>
        
        <span class="toolbar-spacer"></span>
        
        <button type="button" class="toolbar-btn" id="btnEditor" onclick="setViewMode('editor')" title="Editor Only">
            <i class="bi bi-code-slash"></i>
        </button>
        <button type="button" class="toolbar-btn active" id="btnSplit" onclick="setViewMode('split')" title="Split View">
            <i class="bi bi-layout-split"></i>
        </button>
        <button type="button" class="toolbar-btn" id="btnPreview" onclick="setViewMode('preview')" title="Preview Only">
            <i class="bi bi-eye"></i>
        </button>
    </div>
    
    <!-- Main Body -->
    <div class="editor-body">
        <!-- Left: Editor + Preview -->
        <div class="editor-left">
            <div class="split-container mode-split" id="splitContainer">
                <div class="editor-pane">
                    <textarea id="content">{{ post.content if post else '' }}</textarea>
                </div>
                <div class="pane-resizer" id="paneResizer"></div>
                <div class="preview-pane">
                    <div class="preview-content" id="previewContent">
                        <div class="preview-placeholder">
                            <i class="bi bi-pencil"></i>
                            Start typing to see preview...
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Status Bar -->
            <div class="status-bar">
                <div class="status-group">
                    <span class="status-item"><strong>Markdown</strong></span>
                    <span class="status-item" id="wordCount">0 words</span>
                    <span class="status-item" id="charCount">0 chars</span>
                    <span class="status-item" id="lineCount">0 lines</span>
                </div>
                <div class="status-group">
                    <span class="status-item" id="autoSaveStatus"><i class="bi bi-cloud-check"></i> Ready</span>
                    <span class="status-item" id="cursorPos">Ln 1, Col 0</span>
                </div>
            </div>
        </div>
        
        <!-- Right: Settings Sidebar -->
        <div class="editor-sidebar">
            <form method="POST" action="{{ admin_url('/posts/edit/' + post.filename) if post else admin_url('/posts/new') }}" id="postForm">
                <input type="hidden" name="title" id="hiddenTitle">
                <input type="hidden" name="content" id="hiddenContent">
                
                <div class="sidebar-section">
                    <h6>Post Settings</h6>
                    
                    <div class="mb-3">
                        <label class="form-label">Slug (URL)</label>
                        <input type="text" name="slug" class="form-control" 
                               value="{{ post.filename[:-3] if post else '' }}"
                               placeholder="auto-generated"
                               {% if post %}readonly{% endif %}>
                        <div class="form-text">Leave empty to auto-generate</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea name="description" class="form-control" rows="2" 
                                  placeholder="Brief description for SEO...">{{ post.description if post else '' }}</textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Tags</label>
                        <input type="text" name="tags" class="form-control" 
                               value="{{ post.tags if post else '' }}"
                               placeholder="tag1, tag2, tag3">
                        <div class="form-text">Comma-separated</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Categories</label>
                        <input type="text" name="categories" class="form-control" 
                               value="{{ post.categories if post else '' }}"
                               placeholder="category1, category2">
                        <div class="form-text">Comma-separated</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Featured Image</label>
                        <div class="input-group">
                            <input type="text" name="image" id="imageUrl" class="form-control" 
                                   value="{{ post.image if post else '' }}"
                                   placeholder="/uploads/image.jpg">
                            <button type="button" class="btn btn-outline-secondary" onclick="openImagePicker()">
                                <i class="bi bi-folder2-open"></i>
                            </button>
                        </div>
                        <div class="image-preview" id="imagePreview" style="display: none;">
                            <img id="previewImg" src="" alt="Preview">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="draft" id="draft"
                                   {% if post and post.draft %}checked{% endif %}>
                            <label class="form-check-label" for="draft">Save as Draft</label>
                        </div>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <button type="submit" class="btn btn-primary mb-2">
                        <i class="bi bi-check-lg me-1"></i> {{ 'Update Post' if post else 'Create Post' }}
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="previewInNewTab()">
                        <i class="bi bi-box-arrow-up-right me-1"></i> Preview
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Image Picker Modal -->
<div class="modal fade" id="imagePickerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-images me-2"></i>Select Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Upload New Image</label>
                    <input type="file" id="uploadInput" accept="image/*" class="form-control">
                </div>
                <hr>
                <label class="form-label">Or Select Existing</label>
                <div class="row g-2" id="imageGallery">Loading...</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/markdown/markdown.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/gfm/gfm.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/continuelist.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.0/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<script>
// Initialize CodeMirror
var editor = CodeMirror.fromTextArea(document.getElementById('content'), {
    mode: 'gfm',
    lineNumbers: true,
    lineWrapping: true,
    extraKeys: {
        "Enter": "newlineAndIndentContinueMarkdownList",
        "Ctrl-B": function() { insertFormat('bold'); },
        "Ctrl-I": function() { insertFormat('italic'); },
        "Ctrl-K": function() { insertFormat('link'); },
        "Ctrl-S": function() { savePost(); }
    }
});

// Configure marked
marked.setOptions({
    highlight: function(code, lang) {
        if (lang && hljs.getLanguage(lang)) {
            return hljs.highlight(code, { language: lang }).value;
        }
        return hljs.highlightAuto(code).value;
    },
    breaks: true,
    gfm: true
});

// Update preview
var updateTimeout;
editor.on('change', function() {
    clearTimeout(updateTimeout);
    updateTimeout = setTimeout(updatePreview, 100);
    updateStats();
});

editor.on('cursorActivity', function() {
    var cursor = editor.getCursor();
    document.getElementById('cursorPos').textContent = 'Ln ' + (cursor.line + 1) + ', Col ' + cursor.ch;
});

function updatePreview() {
    var content = editor.getValue();
    if (content.trim()) {
        var html = marked.parse(content);
        document.getElementById('previewContent').innerHTML = html;
        document.querySelectorAll('#previewContent pre code').forEach(function(block) {
            hljs.highlightElement(block);
        });
    } else {
        document.getElementById('previewContent').innerHTML = '<div class="preview-placeholder"><i class="bi bi-pencil"></i>Start typing to see preview...</div>';
    }
}

function updateStats() {
    var content = editor.getValue();
    var words = content.trim() ? content.trim().split(/\s+/).length : 0;
    document.getElementById('wordCount').textContent = words + ' words';
    document.getElementById('charCount').textContent = content.length + ' chars';
    document.getElementById('lineCount').textContent = editor.lineCount() + ' lines';
}

function insertFormat(type) {
    var selection = editor.getSelection();
    var cursor = editor.getCursor();
    var line = editor.getLine(cursor.line);
    
    var formats = {
        'bold': { before: '**', after: '**', placeholder: 'bold text' },
        'italic': { before: '*', after: '*', placeholder: 'italic text' },
        'strikethrough': { before: '~~', after: '~~', placeholder: 'strikethrough' },
        'code': { before: '`', after: '`', placeholder: 'code' },
        'h1': { before: '# ', after: '', placeholder: 'Heading 1', line: true },
        'h2': { before: '## ', after: '', placeholder: 'Heading 2', line: true },
        'h3': { before: '### ', after: '', placeholder: 'Heading 3', line: true },
        'ul': { before: '- ', after: '', placeholder: 'List item', line: true },
        'ol': { before: '1. ', after: '', placeholder: 'List item', line: true },
        'task': { before: '- [ ] ', after: '', placeholder: 'Task', line: true },
        'quote': { before: '> ', after: '', placeholder: 'Quote', line: true },
        'hr': { before: '\n---\n', after: '', placeholder: '' },
        'link': { before: '[', after: '](url)', placeholder: 'link text' },
        'image': { before: '![', after: '](image-url)', placeholder: 'alt text' },
        'codeblock': { before: '```\n', after: '\n```', placeholder: 'code' },
        'table': { before: '| Header | Header |\n|--------|--------|\n| Cell   | Cell   |\n', after: '', placeholder: '' }
    };
    
    var format = formats[type];
    if (!format) return;
    
    if (format.line) {
        var newLine = format.before + (selection || format.placeholder);
        editor.replaceRange(newLine, {line: cursor.line, ch: 0}, {line: cursor.line, ch: line.length});
    } else {
        if (selection) {
            editor.replaceSelection(format.before + selection + format.after);
        } else {
            var text = format.before + format.placeholder + format.after;
            editor.replaceSelection(text);
            var newCursor = editor.getCursor();
            editor.setSelection(
                {line: newCursor.line, ch: newCursor.ch - format.after.length - format.placeholder.length},
                {line: newCursor.line, ch: newCursor.ch - format.after.length}
            );
        }
    }
    editor.focus();
}

function setViewMode(mode) {
    var container = document.getElementById('splitContainer');
    container.className = 'split-container mode-' + mode;
    
    document.getElementById('btnEditor').classList.remove('active');
    document.getElementById('btnSplit').classList.remove('active');
    document.getElementById('btnPreview').classList.remove('active');
    
    if (mode === 'editor') document.getElementById('btnEditor').classList.add('active');
    else if (mode === 'split') document.getElementById('btnSplit').classList.add('active');
    else document.getElementById('btnPreview').classList.add('active');
    
    if (mode !== 'editor') updatePreview();
    setTimeout(function() { editor.refresh(); }, 10);
}

function savePost() {
    document.getElementById('hiddenTitle').value = document.getElementById('postTitle').value;
    document.getElementById('hiddenContent').value = editor.getValue();
    document.getElementById('postForm').submit();
}

function previewInNewTab() {
    var content = editor.getValue();
    var html = marked.parse(content);
    var title = document.getElementById('postTitle').value || 'Preview';
    var w = window.open('', '_blank');
    w.document.write('<!DOCTYPE html><html><head><title>' + title + '</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css"><style>body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;max-width:800px;margin:40px auto;padding:20px;line-height:1.8;}pre{background:#f6f8fa;padding:16px;border-radius:6px;overflow-x:auto;}code{background:#f6f8fa;padding:2px 6px;border-radius:3px;}pre code{background:none;padding:0;}blockquote{border-left:4px solid #ddd;margin:1em 0;padding:0.5em 1em;color:#666;}table{border-collapse:collapse;width:100%;}th,td{border:1px solid #ddd;padding:8px 12px;}th{background:#f6f8fa;}</style></head><body><h1>' + title + '</h1>' + html + '<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"><\/script><script>hljs.highlightAll();<\/script></body></html>');
    w.document.close();
}

// Image handling
var imageUrlInput = document.getElementById('imageUrl');
var imagePreview = document.getElementById('imagePreview');
var previewImg = document.getElementById('previewImg');

if (imageUrlInput.value) {
    previewImg.src = imageUrlInput.value;
    imagePreview.style.display = 'block';
}

imageUrlInput.addEventListener('input', function() {
    if (this.value) {
        previewImg.src = this.value;
        imagePreview.style.display = 'block';
    } else {
        imagePreview.style.display = 'none';
    }
});

function openImagePicker() {
    new bootstrap.Modal(document.getElementById('imagePickerModal')).show();
    loadImageGallery();
}

function loadImageGallery() {
    fetch('{{ admin_url("/api/images") }}')
    .then(function(r) { return r.json(); })
    .then(function(data) {
        var gallery = document.getElementById('imageGallery');
        if (data.images && data.images.length > 0) {
            gallery.innerHTML = data.images.map(function(img) {
                return '<div class="col-4 col-md-3"><div class="card" style="cursor:pointer;" onclick="selectImage(\'' + img.url + '\')"><img src="' + img.url + '" class="card-img-top" style="height:80px;object-fit:cover;"></div></div>';
            }).join('');
        } else {
            gallery.innerHTML = '<div class="col-12 text-center py-4 text-muted">No images uploaded yet</div>';
        }
    });
}

function selectImage(url) {
    imageUrlInput.value = url;
    previewImg.src = url;
    imagePreview.style.display = 'block';
    bootstrap.Modal.getInstance(document.getElementById('imagePickerModal')).hide();
}

document.getElementById('uploadInput').addEventListener('change', function() {
    var file = this.files[0];
    if (!file) return;
    var formData = new FormData();
    formData.append('file', file);
    fetch('{{ admin_url("/upload") }}', { method: 'POST', body: formData })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            loadImageGallery();
            selectImage(data.url);
        }
    });
});

// Pane resizer
var resizer = document.getElementById('paneResizer');
var editorPane = document.querySelector('.editor-pane');
var previewPane = document.querySelector('.preview-pane');
var isResizing = false;

resizer.addEventListener('mousedown', function(e) {
    isResizing = true;
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
});

document.addEventListener('mousemove', function(e) {
    if (!isResizing) return;
    var container = document.getElementById('splitContainer');
    var rect = container.getBoundingClientRect();
    var pct = ((e.clientX - rect.left) / rect.width) * 100;
    if (pct > 20 && pct < 80) {
        editorPane.style.flex = '0 0 ' + pct + '%';
        previewPane.style.flex = '0 0 ' + (100 - pct) + '%';
    }
});

document.addEventListener('mouseup', function() {
    if (isResizing) {
        isResizing = false;
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
        editor.refresh();
    }
});

// Auto-generate slug
document.getElementById('postTitle').addEventListener('blur', function() {
    var slugInput = document.querySelector('input[name="slug"]');
    if (!slugInput.readOnly && !slugInput.value) {
        slugInput.value = this.value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
    }
});

// Form submission
document.getElementById('postForm').addEventListener('submit', function(e) {
    document.getElementById('hiddenTitle').value = document.getElementById('postTitle').value;
    document.getElementById('hiddenContent').value = editor.getValue();
});

// Paste image
editor.getWrapperElement().addEventListener('paste', function(e) {
    var items = e.clipboardData.items;
    for (var i = 0; i < items.length; i++) {
        if (items[i].type.indexOf('image') !== -1) {
            e.preventDefault();
            var file = items[i].getAsFile();
            var formData = new FormData();
            formData.append('file', file);
            fetch('{{ admin_url("/upload") }}', { method: 'POST', body: formData })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success) {
                    editor.replaceSelection('![image](' + data.url + ')');
                }
            });
            break;
        }
    }
});

// Auto-save functionality
var autoSaveInterval = null;
var lastSavedContent = '';
var currentFilename = '{{ post.filename if post else "" }}';
var hasUnsavedChanges = false;

function getPostData() {
    return {
        title: document.getElementById('postTitle').value,
        content: editor.getValue(),
        slug: document.querySelector('input[name="slug"]').value,
        description: document.querySelector('textarea[name="description"]').value,
        tags: document.querySelector('input[name="tags"]').value,
        categories: document.querySelector('input[name="categories"]').value,
        image: document.getElementById('imageUrl').value,
        filename: currentFilename || null
    };
}

function autoSave() {
    var data = getPostData();
    
    // Don't save if no title
    if (!data.title.trim()) {
        return;
    }
    
    // Check if content changed
    var currentContent = JSON.stringify(data);
    if (currentContent === lastSavedContent) {
        return;
    }
    
    // Update status
    var statusEl = document.getElementById('autoSaveStatus');
    statusEl.innerHTML = '<i class="bi bi-cloud-arrow-up"></i> Saving...';
    statusEl.style.color = '#f59e0b';
    
    fetch('{{ admin_url("/posts/autosave") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(function(r) { return r.json(); })
    .then(function(response) {
        if (response.success) {
            lastSavedContent = currentContent;
            hasUnsavedChanges = false;
            if (response.filename && !currentFilename) {
                currentFilename = response.filename;
            }
            statusEl.innerHTML = '<i class="bi bi-cloud-check"></i> Saved ' + response.timestamp;
            statusEl.style.color = '#10b981';
        } else {
            statusEl.innerHTML = '<i class="bi bi-cloud-slash"></i> Save failed';
            statusEl.style.color = '#ef4444';
        }
    })
    .catch(function(err) {
        statusEl.innerHTML = '<i class="bi bi-cloud-slash"></i> Save failed';
        statusEl.style.color = '#ef4444';
    });
}

// Also save to localStorage as backup
function saveToLocalStorage() {
    var data = getPostData();
    if (data.title || data.content) {
        localStorage.setItem('draft_' + (currentFilename || 'new'), JSON.stringify(data));
    }
}

// Restore from localStorage if available
function restoreFromLocalStorage() {
    var key = 'draft_' + (currentFilename || 'new');
    var saved = localStorage.getItem(key);
    if (saved && !editor.getValue().trim()) {
        try {
            var data = JSON.parse(saved);
            if (data.content && confirm('Found unsaved draft. Restore it?')) {
                if (data.title) document.getElementById('postTitle').value = data.title;
                if (data.content) editor.setValue(data.content);
                if (data.description) document.querySelector('textarea[name="description"]').value = data.description;
                if (data.tags) document.querySelector('input[name="tags"]').value = data.tags;
                if (data.categories) document.querySelector('input[name="categories"]').value = data.categories;
                if (data.image) document.getElementById('imageUrl').value = data.image;
                updatePreview();
                updateStats();
            }
        } catch(e) {}
    }
}

// Track changes
editor.on('change', function() {
    hasUnsavedChanges = true;
    saveToLocalStorage();
});

document.getElementById('postTitle').addEventListener('input', function() {
    hasUnsavedChanges = true;
    saveToLocalStorage();
});

// Warn before leaving with unsaved changes
window.addEventListener('beforeunload', function(e) {
    if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = '';
    }
});

// Clear localStorage on successful form submit
document.getElementById('postForm').addEventListener('submit', function() {
    hasUnsavedChanges = false;
    localStorage.removeItem('draft_' + (currentFilename || 'new'));
});

// Start auto-save interval (every 30 seconds)
autoSaveInterval = setInterval(autoSave, 30000);

// Initialize
window.addEventListener('load', function() {
    updatePreview();
    updateStats();
    editor.refresh();
    restoreFromLocalStorage();
    lastSavedContent = JSON.stringify(getPostData());
});
</script>
{% endblock %}
